<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:'Poppins',sans-serif;
background:linear-gradient(-45deg,#ff9a9e,#fecfef,#fad0c4,#fbc2eb);
background-size:400% 400%;
animation:gradientBG 12s ease infinite;
padding:20px;
margin:0;
}
@keyframes gradientBG{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

.top-bar{
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
margin-bottom:15px;
}

h2{color:#d63384;}

.logout-btn{
background:#ff4d6d;
color:white;
border:none;
padding:8px 15px;
border-radius:20px;
cursor:pointer;
font-weight:600;
}

.search-box{text-align:center;margin-bottom:15px;}
.search-box input{
padding:10px;
width:90%;
max-width:400px;
border-radius:20px;
border:none;
outline:none;
}

.tabs{
display:flex;
justify-content:center;
flex-wrap:wrap;
margin-bottom:10px;
}
.tab-btn{
padding:8px 15px;
border:none;
cursor:pointer;
background:#ffd6e8;
margin:5px;
border-radius:20px;
font-weight:600;
}
.tab-btn:hover{
background:#ff4da6;
color:white;
}

.delete-container{
text-align:center;
margin-bottom:10px;
}

.delete-btn{
display:none;
background:#ff1744;
color:white;
border:none;
padding:8px 15px;
border-radius:20px;
cursor:pointer;
font-weight:600;
}

table{
width:100%;
border-collapse:collapse;
background:white;
border-radius:15px;
overflow:hidden;
box-shadow:0 8px 20px rgba(255,0,150,0.3);
}

th,td{
padding:10px;
text-align:center;
font-size:14px;
}
th{
background:#ff4da6;
color:white;
}
tr:nth-child(even){background:#ffe6f2;}

.status-select{
padding:5px;
border-radius:8px;
border:0.1px solid #000;
background:#ffe6f2;
}

.download-btn{
background:#6c5ce7;
color:white;
border:none;
padding:6px 10px;
border-radius:15px;
cursor:pointer;
font-size:12px;
}
</style>
</head>

<body>

<div class="top-bar">
<h2>üìä Admin Dashboard</h2>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Search..." onkeyup="loadFeedback()">
</div>

<!-- STATUS FILTER -->
<div class="tabs">
<button class="tab-btn active" onclick="switchTab('ALL',this)">ALL</button>
<button class="tab-btn" onclick="switchTab('Pending',this)">Pending</button>
<button class="tab-btn" onclick="switchTab('In Progress',this)">In Progress</button>
<button class="tab-btn" onclick="switchTab('Solved',this)">Solved</button>
</div>

<!-- ‚≠ê RATING FILTER -->
<div class="tabs">
<button class="tab-btn active" onclick="switchRating('ALL',this)">All Ratings</button>
<button class="tab-btn" onclick="switchRating(5,this)">5 ‚òÖ</button>
<button class="tab-btn" onclick="switchRating(4,this)">4 ‚òÖ</button>
<button class="tab-btn" onclick="switchRating(3,this)">3 ‚òÖ</button>
<button class="tab-btn" onclick="switchRating(2,this)">2 ‚òÖ</button>
<button class="tab-btn" onclick="switchRating(1,this)">1 ‚òÖ</button>
</div>

<div class="delete-container">
<button id="deleteBtn" class="delete-btn" onclick="deleteSelected()">üóë Delete Selected</button>
</div>

<table>
<thead>
<tr>
<th>Select</th>
<th>ID</th>
<th>Hospital</th>
<th>Patient</th>
<th>Issue</th>
<th>Feedback</th>
<th>Rating</th>
<th>Status</th>
<th>PDF</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const { jsPDF } = window.jspdf;

const supabaseClient = supabase.createClient(
"https://zhnamyobwlyrommgpedi.supabase.co",
"sb_publishable_FKBkWP3UPo-Qtobv7gjW4A_gvNxLsFh"
);

let currentStatus="ALL";
let currentRating="ALL";

/* ================= LOAD DATA ================= */
async function loadFeedback(){

let query = supabaseClient
.from("Feedback")
.select("*")
.order("id",{ascending:false});

if(currentStatus!=="ALL"){
query=query.eq("FeedbackStatus",currentStatus);
}

const { data, error } = await query;
if(error){ alert("Error loading data"); return; }

const searchValue=document.getElementById("searchInput").value.toLowerCase();
const tableBody=document.getElementById("tableBody");
tableBody.innerHTML="";

data.forEach(row=>{

if(
(
row.HospitalName.toLowerCase().includes(searchValue) ||
row.PatientName.toLowerCase().includes(searchValue) ||
row.PatientIssue.toLowerCase().includes(searchValue)
)
&&
(
currentRating==="ALL" || row.Rating==currentRating
)
){

const stars="‚òÖ".repeat(row.Rating||0);

tableBody.innerHTML+=`
<tr>
<td>
<input type="checkbox" class="row-checkbox" value="${row.id}" onchange="toggleDeleteButton()">
</td>
<td>${row.id}</td>
<td>${row.HospitalName}</td>
<td>${row.PatientName}</td>
<td>${row.PatientIssue}</td>
<td>${row.PatientFeedback}</td>
<td style="color:#ff4da6">${stars}</td>
<td>
<select class="status-select" onchange="updateStatus(${row.id},this.value)">
<option value="Pending" ${row.FeedbackStatus=="Pending"?"selected":""}>Pending</option>
<option value="In Progress" ${row.FeedbackStatus=="In Progress"?"selected":""}>In Progress</option>
<option value="Solved" ${row.FeedbackStatus=="Solved"?"selected":""}>Solved</option>
</select>
</td>
<td>
<button class="download-btn" onclick='downloadPDF(${JSON.stringify(row)})'>
Download
</button>
</td>
</tr>
`;
}
});

document.getElementById("deleteBtn").style.display="none";
}

/* ================= STATUS FILTER ================= */
function switchTab(status,btn){
currentStatus=status;
document.querySelectorAll(".tabs:first-of-type .tab-btn")
.forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
loadFeedback();
}

/* ================= RATING FILTER ================= */
function switchRating(rating,btn){
currentRating=rating;
document.querySelectorAll(".tabs:nth-of-type(2) .tab-btn")
.forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
loadFeedback();
}

/* ================= DELETE ================= */
function toggleDeleteButton(){
const checked=document.querySelectorAll(".row-checkbox:checked").length;
document.getElementById("deleteBtn").style.display=checked>0?"inline-block":"none";
}

async function deleteSelected(){

const selected=Array.from(document.querySelectorAll(".row-checkbox:checked"))
.map(cb=>parseInt(cb.value));

if(selected.length===0) return;

if(!confirm("Are you sure you want to delete selected feedback?")) return;

const { error } = await supabaseClient
.from("Feedback")
.delete()
.in("id",selected);

if(error){
alert("Error deleting data");
}else{
alert("Deleted successfully!");
loadFeedback();
}
}

/* ================= UPDATE STATUS ================= */
async function updateStatus(id,newStatus){
await supabaseClient.from("Feedback")
.update({FeedbackStatus:newStatus})
.eq("id",id);
loadFeedback();
}

/* ================= PDF FUNCTION (UNCHANGED) ================= */
/* ================= PDF FUNCTION (COMPACT FLEX STYLE) ================= */
function downloadPDF(row){

const doc = new jsPDF({
  orientation: "landscape",
  unit: "mm",
  format: "a4"
});

const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();
const today = new Date().toLocaleDateString();

/* =======================================================
   üî∑ HEADER SECTION (COMPACT)
======================================================= */
doc.setFillColor(0, 102, 204);
doc.rect(0, 0, pageWidth, 20, "F");

doc.setFont("helvetica","bold");
doc.setFontSize(18);
doc.setTextColor(255,255,255);
doc.text("HOSPITAL FEEDBACK REPORT", 15, 13);

doc.setFontSize(10);
doc.text("Generated: " + today, pageWidth - 55, 13);


/* =======================================================
   üè• HOSPITAL INFO (FLEX 2-COLUMN STYLE)
======================================================= */
doc.setFillColor(240, 248, 255);
doc.roundedRect(10, 25, pageWidth-20, 25, 4, 4, "F");

doc.setFontSize(14);
doc.setTextColor(0, 102, 204);
doc.setFont("helvetica","bold");
doc.text("Hospital Information", 15, 32);

doc.setFontSize(12);
doc.setFont("helvetica","normal");
doc.setTextColor(0,0,0);

/* Left Column */
doc.text("Hospital: " + row.HospitalName, 15, 38);
doc.text("Patient: " + row.PatientName, 15, 44);

/* Right Column */
let statusColor = [255,193,7];
if(row.FeedbackStatus === "In Progress"){ statusColor = [0,123,255]; }
if(row.FeedbackStatus === "Solved"){ statusColor = [40,167,69]; }

doc.setTextColor(...statusColor);
doc.text("Status: " + row.FeedbackStatus, pageWidth/2 + 10, 38);

doc.setTextColor(0,0,0);
doc.text("Rating: " + (row.Rating || 0) + " / 5", pageWidth/2 + 10, 44);


/* =======================================================
   ü©∫ ISSUE + FEEDBACK (COMPACT FLEX BOX)
======================================================= */
doc.setFillColor(255, 245, 245);
doc.roundedRect(10, 55, pageWidth-20, 30, 4, 4, "F");

doc.setFontSize(14);
doc.setTextColor(220, 53, 69);
doc.setFont("helvetica","bold");
doc.text("Patient Issue", 15, 62);

doc.setFontSize(12);
doc.setFont("helvetica","normal");
doc.setTextColor(0,0,0);

const issueText = doc.splitTextToSize(row.PatientIssue, pageWidth-30);
doc.text(issueText, 15, 68);


/* =======================================================
   üí¨ FEEDBACK SECTION
======================================================= */
doc.setFillColor(240, 255, 240);
doc.roundedRect(10, 90, pageWidth-20, 30, 4, 4, "F");

doc.setFontSize(14);
doc.setTextColor(0, 150, 136);
doc.setFont("helvetica","bold");
doc.text("Patient Feedback", 15, 97);

doc.setFontSize(12);
doc.setFont("helvetica","normal");
doc.setTextColor(0,0,0);

const feedbackText = doc.splitTextToSize(row.PatientFeedback, pageWidth-30);
doc.text(feedbackText, 15, 103);


/* =======================================================
   ‚≠ê STAR DISPLAY (COMPACT INLINE)
======================================================= */
doc.setFontSize(14);
doc.setFont("helvetica","bold");
doc.setTextColor(255,140,0);
doc.text("Stars:", 15, 130);

let starX = 35;
doc.setFontSize(18);

for(let i=1;i<=5;i++){
  if(i <= row.Rating){
    doc.setTextColor(255,193,7);
  }else{
    doc.setTextColor(200,200,200);
  }
  doc.text("*", starX, 130);
  starX += 7;
}


/* =======================================================
   ‚úÖ SUCCESS SECTION (ONLY IF SOLVED - COMPACT)
======================================================= */
if(row.FeedbackStatus === "Solved"){

doc.setFillColor(230,260,230);
doc.roundedRect(10, 140, pageWidth-20, 28, 4, 4, "F");

doc.setFont("helvetica","bold");
doc.setFontSize(14);
doc.setTextColor(40,167,69);
doc.text("SUCCESSFULLY COMPLETED", 15, 150);

doc.setFont("helvetica","normal");
doc.setFontSize(12);
doc.setTextColor(0,0,0);
doc.text(
"This issue has been resolved successfully by hospital administration.",
15,
160
);
}


/* =======================================================
   üîπ FOOTER (SMALL & CLEAN)
======================================================= */
doc.setDrawColor(200,200,200);
doc.line(10, pageHeight - 10, pageWidth - 10, pageHeight - 10);

doc.setFontSize(10);
doc.setTextColor(120,120,120);
doc.text(
"Confidential Medical Document ‚Ä¢ Administrative Access Only",
15,
pageHeight - 4
);

doc.save("Hospital_Feedback_" + row.id + ".pdf");
}

/* ================= LOGOUT ================= */
function logout(){
alert("Logged out successfully!");
window.location.href="index.html";
}

loadFeedback();
</script>

</body>
</html>