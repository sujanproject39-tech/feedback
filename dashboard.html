<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:'Poppins',sans-serif;
background:linear-gradient(-45deg,#ff9a9e,#fecfef,#fad0c4,#fbc2eb);
background-size:400% 400%;
animation:gradientBG 12s ease infinite;
padding:20px;
margin:0;
}
@keyframes gradientBG{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

.top-bar{
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
margin-bottom:15px;
}

h2{color:#d63384;}

.logout-btn{
background:#ff4d6d;
color:white;
border:none;
padding:8px 15px;
border-radius:20px;
cursor:pointer;
font-weight:600;
}

.search-box{text-align:center;margin-bottom:15px;}
.search-box input{
padding:10px;
width:90%;
max-width:400px;
border-radius:20px;
border:none;
outline:none;
}

.tabs{
display:flex;
justify-content:center;
flex-wrap:wrap;
margin-bottom:10px;
}
.tab-btn{
padding:8px 15px;
border:none;
cursor:pointer;
background:#ffd6e8;
margin:5px;
border-radius:20px;
font-weight:600;
}
.tab-btn.active{
background:#ff4da6;
color:white;
}

.delete-container{
text-align:center;
margin-bottom:10px;
}

.delete-btn{
display:none;
background:#ff1744;
color:white;
border:none;
padding:8px 15px;
border-radius:20px;
cursor:pointer;
font-weight:600;
}

table{
width:100%;
border-collapse:collapse;
background:white;
border-radius:15px;
overflow:hidden;
box-shadow:0 8px 20px rgba(255,0,150,0.3);
}

th,td{
padding:10px;
text-align:center;
font-size:14px;
}
th{
background:#ff4da6;
color:white;
}
tr:nth-child(even){background:#ffe6f2;}

.status-select{
padding:5px;
border-radius:8px;
border:none;
background:#ffe6f2;
}

.download-btn{
background:#6c5ce7;
color:white;
border:none;
padding:6px 10px;
border-radius:15px;
cursor:pointer;
font-size:12px;
}
</style>
</head>

<body>

<div class="top-bar">
<h2>ðŸ“Š Admin Dashboard</h2>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Search..." onkeyup="loadFeedback()">
</div>

<div class="tabs">
<button class="tab-btn active" onclick="switchTab('ALL',this)">ALL</button>
<button class="tab-btn" onclick="switchTab('Pending',this)">Pending</button>
<button class="tab-btn" onclick="switchTab('In Progress',this)">In Progress</button>
<button class="tab-btn" onclick="switchTab('Solved',this)">Solved</button>
</div>

<div class="delete-container">
<button id="deleteBtn" class="delete-btn" onclick="deleteSelected()">ðŸ—‘ Delete Selected</button>
</div>

<table>
<thead>
<tr>
<th>Select</th>
<th>ID</th>
<th>Hospital</th>
<th>Patient</th>
<th>Issue</th>
<th>Feedback</th>
<th>Rating</th>
<th>Status</th>
<th>PDF</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const { jsPDF } = window.jspdf;

const supabaseClient = supabase.createClient(
"https://zhnamyobwlyrommgpedi.supabase.co",
"sb_publishable_FKBkWP3UPo-Qtobv7gjW4A_gvNxLsFh"
);

let currentStatus="ALL";

async function loadFeedback(){

let query = supabaseClient
.from("Feedback")
.select("*")
.order("id",{ascending:false});

if(currentStatus!=="ALL"){
query=query.eq("FeedbackStatus",currentStatus);
}

const { data, error } = await query;
if(error){ alert("Error loading data"); return; }

const searchValue=document.getElementById("searchInput").value.toLowerCase();
const tableBody=document.getElementById("tableBody");
tableBody.innerHTML="";

data.forEach(row=>{

if(
row.HospitalName.toLowerCase().includes(searchValue) ||
row.PatientName.toLowerCase().includes(searchValue) ||
row.PatientIssue.toLowerCase().includes(searchValue)
){

const stars="â˜…".repeat(row.Rating||0);

tableBody.innerHTML+=`
<tr>
<td>
<input type="checkbox" class="row-checkbox" value="${row.id}" onchange="toggleDeleteButton()">
</td>
<td>${row.id}</td>
<td>${row.HospitalName}</td>
<td>${row.PatientName}</td>
<td>${row.PatientIssue}</td>
<td>${row.PatientFeedback}</td>
<td style="color:#ff4da6">${stars}</td>
<td>
<select class="status-select" onchange="updateStatus(${row.id},this.value)">
<option value="Pending" ${row.FeedbackStatus=="Pending"?"selected":""}>Pending</option>
<option value="In Progress" ${row.FeedbackStatus=="In Progress"?"selected":""}>In Progress</option>
<option value="Solved" ${row.FeedbackStatus=="Solved"?"selected":""}>Solved</option>
</select>
</td>
<td>
<button class="download-btn" onclick='downloadPDF(${JSON.stringify(row)})'>
Download
</button>
</td>
</tr>
`;
}
});

document.getElementById("deleteBtn").style.display="none";
}

function toggleDeleteButton(){
const checked=document.querySelectorAll(".row-checkbox:checked").length;
document.getElementById("deleteBtn").style.display=checked>0?"inline-block":"none";
}

async function deleteSelected(){

const selected=Array.from(document.querySelectorAll(".row-checkbox:checked"))
.map(cb=>parseInt(cb.value));

if(selected.length===0) return;

if(!confirm("Are you sure you want to delete selected feedback?")) return;

const { error } = await supabaseClient
.from("Feedback")
.delete()
.in("id",selected);

if(error){
alert("Error deleting data");
}else{
alert("Deleted successfully!");
loadFeedback();
}
}

function switchTab(status,btn){
currentStatus=status;
document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
loadFeedback();
}

async function updateStatus(id,newStatus){
await supabaseClient.from("Feedback")
.update({FeedbackStatus:newStatus})
.eq("id",id);
loadFeedback();
}

function downloadPDF(row){

const doc = new jsPDF({
  orientation: "landscape",
  unit: "mm",
  format: "a4"
});

const today = new Date().toLocaleDateString();
const pageWidth = doc.internal.pageSize.getWidth();

/* ====== HEADER ====== */
doc.setFillColor(102, 0, 153); // deep hospital purple
doc.rect(0, 0, pageWidth, 30, "F");

doc.setFont("helvetica","bold");
doc.setFontSize(24);
doc.setTextColor(255,255,255);
doc.text("HOSPITAL FEEDBACK REPORT", 14, 18);

doc.setFontSize(12);
doc.text(`Generated on: ${today}`, pageWidth - 70, 18);

/* ====== CARD BACKGROUND ====== */
doc.setFillColor(245, 240, 255);
doc.roundedRect(10, 40, pageWidth-20, 45, 5, 5, "F");

/* ====== HOSPITAL INFO ====== */
doc.setTextColor(102,0,153);
doc.setFontSize(16);
doc.text("Hospital Information", 15, 50);

doc.setTextColor(0,0,0);
doc.setFont("helvetica","normal");
doc.setFontSize(13);

doc.text(`Hospital Name: ${row.HospitalName}`, 15, 60);
doc.text(`Patient Name: ${row.PatientName}`, 15, 68);
doc.text(`Status: ${row.FeedbackStatus}`, 15, 76);

/* ====== STAR RATING ====== */
let startX = 15;
let startY = 85;

doc.setFontSize(16);
doc.setTextColor(255, 193, 7); // gold stars

for(let i=1; i<=5; i++){
  if(i <= row.Rating){
    doc.text("*", startX, startY);
  } else {
    doc.setTextColor(200,200,200);
    doc.text("*", startX, startY);
    doc.setTextColor(255,193,7);
  }
  startX += 8;
}

/* ====== ISSUE SECTION ====== */
doc.setFillColor(255, 230, 240);
doc.roundedRect(10, 95, pageWidth-20, 45, 5, 5, "F");

doc.setTextColor(214,51,132);
doc.setFontSize(16);
doc.text("Patient Issue", 15, 105);

doc.setFontSize(13);
doc.setTextColor(0,0,0);

const issueLines = doc.splitTextToSize(row.PatientIssue, pageWidth-30);
doc.text(issueLines, 15, 115);

/* ====== FEEDBACK SECTION ====== */
doc.setFillColor(230, 255, 250);
doc.roundedRect(10, 150, pageWidth-20, 45, 5, 5, "F");

doc.setTextColor(0,150,136);
doc.setFontSize(16);
doc.text("Patient Feedback", 15, 160);

doc.setFontSize(13);
doc.setTextColor(0,0,0);

const feedbackLines = doc.splitTextToSize(row.PatientFeedback, pageWidth-30);
doc.text(feedbackLines, 15, 170);

/* ====== FOOTER ====== */
doc.setDrawColor(180,180,180);
doc.line(10, 195, pageWidth-10, 195);

doc.setFontSize(10);
doc.setTextColor(120,120,120);
doc.text("Confidential Hospital Document â€¢ Authorized Admin Use Only", 15, 202);

doc.save(`Hospital_Feedback_${row.id}.pdf`);
}

function logout(){
alert("Logged out successfully!");
window.location.href="index.html";
}

loadFeedback();
</script>

</body>
</html>